# Codebase Audit & Improvement Plan

This document outlines the findings from a comprehensive audit of the `railway-api` backend and related components. It highlights immediate action items, missing configurations, and suggestions for improvement.

## üö® Critical Action Items (Must Fix)

### 1. Missing SQL Tables
The current `supabase/migrations` folder contains `20240120_create_embeddings.sql` and others, but **missing the base schema** for `user_reports`, `analyses`, and `creator_data_settings` which the code relies on.

**Action:** Run the following SQL in your Supabase SQL Editor to create the missing tables:

```sql
-- base_schema.sql

-- 1. Create 'analyses' table (Legacy/Basic)
create table if not exists analyses (
  id bigint generated by default as identity primary key,
  access_key text not null unique,
  channel_name text not null,
  email text not null,
  analysis_status text default 'queued', -- queued, processing, completed, failed
  report_generated_at timestamp with time zone,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. Create 'user_reports' table (Main for Frontend/Premium)
create table if not exists user_reports (
  id bigint generated by default as identity primary key,
  user_id text, -- optional if linking to auth users
  access_key text not null unique,
  channel_name text,
  channel_handle text,
  email text,
  status text default 'pending', -- pending, processing, completed, failed
  progress_percentage integer default 0,
  current_phase text,
  retry_count integer default 0,
  report_data jsonb, -- Stores the full analysis result
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. Enable Realtime for user_reports (if not already)
alter publication supabase_realtime add table user_reports;
```

### 2. Dependency Cleanup
The `railway-api/requirements.txt` file contains duplicate entries and disorganized dependencies.

**Action:** Replace `railway-api/requirements.txt` with this clean version:

```text
# --- Core API & Web ---
fastapi
uvicorn
requests
httpx
python-dotenv

# --- AI & ML ---
openai
google-generativeai
groq
transformers>=4.30.0
torch>=2.0.0
sentence-transformers>=2.2.2
scikit-learn>=1.3.0
xgboost>=2.0.0
joblib
numpy
pandas

# --- YouTube & Data ---
yt-dlp>=2025.01.01
google-api-python-client
youtube-transcript-api
pytrends
supabase>=2.3.0

# --- Media Processing (Optional/Premium) ---
openai-whisper
faster-whisper
pillow>=10.0.0
opencv-python-headless>=4.8.0

# --- Integrations ---
stripe
```

### 3. Environment Variables
Your backend (`server.py` & `GAP_ULTIMATE.py`) requires these specific environment variables. Ensure they are set in Railway (and `.env` for local dev).

**Required Keys:**
- `SUPABASE_URL`
- `SUPABASE_SERVICE_KEY` (or `SUPABASE_SERVICE_ROLE_KEY`)
- `API_SECRET_KEY` (Critical for security in Production! Defaults to insecure in dev)
- `RESEND_API_KEY` (For email notifications)
- `YOUTUBE_API_KEY`
- `OPENAI_API_KEY` (or `GEMINI_API_KEY` / `GROQ_API_KEY` depending on config)
- `STRIPE_SECRET_KEY`
- `STRIPE_WEBHOOK_SECRET`

**Premium/Optional Keys:**
- `GOOGLE_CLIENT_ID` (For OAuth)
- `GOOGLE_CLIENT_SECRET` (For OAuth)
- `ENCRYPTION_KEY` (For token storage)

## ‚ö†Ô∏è Codebase Findings & Observations

### 1. Confusing File Structure
- **Issue:** You have `gap_analyzer.py` and `gap_analyzer_v2.py` in the root directory, but `railway-api/server.py` actually uses `railway-api/GAP_ULTIMATE.py`.
- **Recommendation:** `gap_analyzer.py` and `v2` in the root seem to be legacy or dev artifacts.
    - **Move** them to a `legacy/` folder or **Delete** them to avoid confusion.
    - Treat `railway-api/GAP_ULTIMATE.py` as the **source of truth**.

### 2. Hardcoded Configuration
- **Issue:** `server.py` line 2243 forces `port = int(os.environ.get("PORT", 8000))`. This is standard, but some `localhost` URLs are hardcoded in `ALLOWED_ORIGINS` (line 48) and `redirect_uri` (line 798).
- **Recommendation:** Ensure `https://gapintel.online` is the only production origin allowed in `ALLOWED_ORIGINS`.

### 3. "Premium" Code Organization
- **Observation:** The `railway-api/premium/` directory is well-structured. However, `GAP_ULTIMATE.py` is a massive single file (1700+ lines).
- **Refactoring Opportunity:** Consider splitting `GAP_ULTIMATE.py` into smaller modules (e.g., `analysis_pipeline.py`, `youtube_connector.py`) and placing them in a `core/` package, similar to how `premium/` is organized.

### 4. Supabase Migrations
- **Status:** You have `create_embeddings.sql`, `realtime_progress.sql`, and `views_training_data.sql`.
- **Gap:** As noted in Critical Items, the base tables (`user_reports`) are assumed to exist. If you deploy to a fresh project, the app will crash without the base SQL provided above.

## üöÄ Recommended Next Steps

1.  **Run the SQL:** Copy the SQL script above and run it in Supabase to ensure your tables are solid.
2.  **Clean Dependencies:** Update `requirements.txt` to speed up build times and reduce docker image size.
3.  **Cleanup:** Archive the old `gap_analyzer.py` scripts from the root folder.
4.  **Verify Secrets:** Double-check `API_SECRET_KEY` is set in Railway to prevent unauthorized usage.
